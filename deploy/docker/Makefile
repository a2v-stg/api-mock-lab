# Mock-Lab Makefile
# Convenient commands for Docker deployment

.PHONY: help build up down restart logs logs-f clean test status db-backup db-restore

# Default target
help:
	@echo "Mock-Lab Docker Commands"
	@echo "========================"
	@echo ""
	@echo "Setup & Deployment:"
	@echo "  make setup      - Setup .env file from template"
	@echo "  make build      - Build Docker images"
	@echo "  make up         - Start all services"
	@echo "  make down       - Stop all services"
	@echo "  make restart    - Restart all services"
	@echo ""
	@echo "Monitoring:"
	@echo "  make logs       - View all logs (static)"
	@echo "  make logs-f     - Follow all logs (live)"
	@echo "  make status     - Show service status"
	@echo ""
	@echo "Database:"
	@echo "  make db-shell   - Access database shell"
	@echo "  make db-backup  - Backup database to file"
	@echo "  make db-restore - Restore database from backup"
	@echo ""
	@echo "Testing & Cleanup:"
	@echo "  make test       - Run deployment test"
	@echo "  make clean      - Remove all containers and volumes (WARNING!)"
	@echo "  make reset      - Complete reset and rebuild"
	@echo ""

# Setup .env file
setup:
	@if [ ! -f .env ]; then \
		cp .env.example .env; \
		echo "âœ… Created .env file from template"; \
		echo "âš ï¸  Please edit .env and update SECRET_KEY and POSTGRES_PASSWORD!"; \
	else \
		echo "âš ï¸  .env file already exists"; \
	fi

# Build images
build:
	@echo "ğŸ”¨ Building Docker images..."
	docker-compose build

# Start services
up: setup
	@echo "ğŸš€ Starting services..."
	docker-compose up -d
	@echo "âœ… Services started"
	@echo "Frontend: http://localhost:3000"
	@echo "Backend:  http://localhost:8001"

# Stop services
down:
	@echo "ğŸ›‘ Stopping services..."
	docker-compose down
	@echo "âœ… Services stopped"

# Restart services
restart:
	@echo "ğŸ”„ Restarting services..."
	docker-compose restart
	@echo "âœ… Services restarted"

# View logs (static)
logs:
	docker-compose logs

# Follow logs (live)
logs-f:
	docker-compose logs -f

# Show status
status:
	@echo "ğŸ“Š Service Status:"
	@docker-compose ps

# Access database shell
db-shell:
	@echo "ğŸ—„ï¸  Accessing database shell..."
	docker-compose exec db psql -U mocklab -d mocklab

# Backup database
db-backup:
	@mkdir -p backups
	@echo "ğŸ’¾ Backing up database..."
	@docker-compose exec -T db pg_dump -U mocklab mocklab > backups/backup_$$(date +%Y%m%d_%H%M%S).sql
	@echo "âœ… Backup saved to backups/"

# Restore database
db-restore:
	@if [ -z "$(FILE)" ]; then \
		echo "âŒ Please specify backup file: make db-restore FILE=backups/backup.sql"; \
		exit 1; \
	fi
	@echo "ğŸ“¥ Restoring database from $(FILE)..."
	@docker-compose exec -T db psql -U mocklab mocklab < $(FILE)
	@echo "âœ… Database restored"

# Run test script
test:
	@echo "ğŸ§ª Running deployment tests..."
	./docker-test.sh

# Clean up (removes volumes - WARNING!)
clean:
	@echo "âš ï¸  This will remove all containers and volumes (including data)!"
	@read -p "Are you sure? [y/N] " -n 1 -r; \
	echo; \
	if [[ $$REPLY =~ ^[Yy]$$ ]]; then \
		docker-compose down -v; \
		echo "âœ… Cleanup complete"; \
	else \
		echo "âŒ Cancelled"; \
	fi

# Complete reset
reset: clean
	@echo "ğŸ”„ Rebuilding from scratch..."
	docker-compose up -d --build
	@echo "âœ… Reset complete"

# Development mode (with SQLite)
dev:
	@echo "ğŸ”§ Starting development mode (SQLite)..."
	./start-backend.sh &
	cd frontend && npm run dev
